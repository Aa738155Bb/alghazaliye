{% extends "layout.html" %}

{% block title %}سندات الصرف{% endblock %}

{% block content %}
<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">سندات الصرف</h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-left">
                    <li class="breadcrumb-item"><a href="/dashboard">الرئيسية</a></li>
                    <li class="breadcrumb-item active">سندات الصرف</li>
                </ol>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- نظرة عامة -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-money-bill-wave ml-2"></i>
                            قائمة سندات الصرف
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-add-payment-voucher">
                                <i class="fas fa-plus"></i> سند صرف جديد
                            </button>
                            <button type="button" class="btn btn-primary ml-2" data-toggle="modal" data-target="#modal-add-receipt-voucher">
                                <i class="fas fa-plus"></i> سند قبض جديد
                            </button>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap datatable">
                            <thead>
                                <tr>
                                    <th>رقم السند</th>
                                    <th>نوع السند</th>
                                    <th>المستفيد</th>
                                    <th>المبلغ</th>
                                    <th>تاريخ العملية</th>
                                    <th>وصف العملية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- بيانات توضيحية -->
                                <tr>
                                    <td>123456</td>
                                    <td><span class="badge badge-danger">سند صرف</span></td>
                                    <td>شركة الخطوط السعودية (مورد)</td>
                                    <td>1000 ريال</td>
                                    <td>2023-06-15</td>
                                    <td>دفعة مقدمة لحجز تذاكر</td>
                                    <td>
                                        <button class="btn btn-info btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>123457</td>
                                    <td><span class="badge badge-success">سند قبض</span></td>
                                    <td>أحمد محمد (عميل)</td>
                                    <td>2500 ريال</td>
                                    <td>2023-06-16</td>
                                    <td>دفعة لتأشيرة عمرة</td>
                                    <td>
                                        <button class="btn btn-info btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>123458</td>
                                    <td><span class="badge badge-danger">سند صرف</span></td>
                                    <td>محمد عبدالله (موظف)</td>
                                    <td>1200 ريال</td>
                                    <td>2023-06-17</td>
                                    <td>مصاريف نثرية</td>
                                    <td>
                                        <button class="btn btn-info btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>123459</td>
                                    <td><span class="badge badge-success">سند قبض</span></td>
                                    <td>صندوق المكتب (صندوق)</td>
                                    <td>5000 ريال</td>
                                    <td>2023-06-18</td>
                                    <td>ايداع يومي</td>
                                    <td>
                                        <button class="btn btn-info btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
</section>
<!-- /.content -->

<!-- Modal - إضافة سند صرف جديد -->
<div class="modal fade" id="modal-add-payment-voucher">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h4 class="modal-title">إضافة سند صرف جديد</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="payment-voucher-form">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                <h5><i class="icon fas fa-info"></i> معلومات عن سند الصرف!</h5>
                                <p>يستخدم سند الصرف عند دفع مبلغ من المكتب لمستفيد (مورد، موظف، عميل، صندوق أو بنك).</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="beneficiary-type">نوع المستفيد <span class="text-danger">*</span></label>
                                <select class="form-control" id="beneficiary-type" required>
                                    <option value="">اختر نوع المستفيد</option>
                                    <option value="supplier">مورد</option>
                                    <option value="employee">موظف</option>
                                    <option value="customer">عميل</option>
                                    <option value="cashbox">صندوق</option>
                                    <option value="bank">بنك</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="beneficiary-name">اسم المستفيد <span class="text-danger">*</span></label>
                                <select class="form-control" id="beneficiary-name" required disabled>
                                    <option value="">يرجى اختيار نوع المستفيد أولاً</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="amount">المبلغ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" min="0" step="0.01" class="form-control" id="amount" placeholder="أدخل المبلغ" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text">ر.س</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="operation-date">تاريخ العملية <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    </div>
                                    <input type="date" class="form-control" id="operation-date" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="description">وصف العملية <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="description" rows="3" placeholder="أدخل وصف مختصر للعملية" required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="financial-account">الحساب المالي <span class="text-danger">*</span></label>
                                <select class="form-control" id="financial-account" required disabled>
                                    <option value="">سيتم تحديد الحساب المالي تلقائياً بناءً على نوع المستفيد</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ السند</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<!-- Modal - إضافة سند قبض جديد -->
<div class="modal fade" id="modal-add-receipt-voucher">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h4 class="modal-title">إضافة سند قبض جديد</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="receipt-voucher-form">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                                <h5><i class="icon fas fa-info"></i> معلومات عن سند القبض!</h5>
                                <p>يستخدم سند القبض عند استلام مبلغ للمكتب من مصدر (مورد، موظف، عميل، صندوق أو بنك).</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="receipt-beneficiary-type">نوع المصدر <span class="text-danger">*</span></label>
                                <select class="form-control" id="receipt-beneficiary-type" required>
                                    <option value="">اختر نوع المصدر</option>
                                    <option value="supplier">مورد</option>
                                    <option value="employee">موظف</option>
                                    <option value="customer">عميل</option>
                                    <option value="cashbox">صندوق</option>
                                    <option value="bank">بنك</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="receipt-beneficiary-name">اسم المصدر <span class="text-danger">*</span></label>
                                <select class="form-control" id="receipt-beneficiary-name" required disabled>
                                    <option value="">يرجى اختيار نوع المصدر أولاً</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="receipt-amount">المبلغ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" min="0" step="0.01" class="form-control" id="receipt-amount" placeholder="أدخل المبلغ" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text">ر.س</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="receipt-operation-date">تاريخ العملية <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    </div>
                                    <input type="date" class="form-control" id="receipt-operation-date" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="receipt-description">وصف العملية <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="receipt-description" rows="3" placeholder="أدخل وصف مختصر للعملية" required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="receipt-financial-account">الحساب المالي <span class="text-danger">*</span></label>
                                <select class="form-control" id="receipt-financial-account" required disabled>
                                    <option value="">سيتم تحديد الحساب المالي تلقائياً بناءً على نوع المصدر</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ السند</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

{% endblock %}

{% block scripts %}
<script>
    // تهيئة النماذج عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
        // استدعاء وظيفة التهيئة لنموذج سند الصرف
        initializeVoucherForm('beneficiary-type', 'beneficiary-name', 'financial-account');
        
        // استدعاء وظيفة التهيئة لنموذج سند القبض
        initializeVoucherForm('receipt-beneficiary-type', 'receipt-beneficiary-name', 'receipt-financial-account');
        
        // تسجيل أحداث إرسال النماذج
        document.getElementById('payment-voucher-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // هنا سيتم إرسال البيانات للخادم (سيتم تنفيذه لاحقاً)
            alert('تم حفظ سند الصرف بنجاح!');
            $('#modal-add-payment-voucher').modal('hide');
        });
        
        document.getElementById('receipt-voucher-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // هنا سيتم إرسال البيانات للخادم (سيتم تنفيذه لاحقاً)
            alert('تم حفظ سند القبض بنجاح!');
            $('#modal-add-receipt-voucher').modal('hide');
        });
    });
    
    // وظيفة لتهيئة نموذج السندات مع ربط الحقول ببعضها
    function initializeVoucherForm(typeFieldId, nameFieldId, accountFieldId) {
        const typeField = document.getElementById(typeFieldId);
        const nameField = document.getElementById(nameFieldId);
        const accountField = document.getElementById(accountFieldId);
        
        // معالجة تغيير نوع المستفيد/المصدر
        typeField.addEventListener('change', function() {
            const selectedType = this.value;
            
            // إعادة تعيين حقل الاسم
            nameField.innerHTML = '';
            nameField.disabled = true;
            
            // إعادة تعيين حقل الحساب المالي
            accountField.innerHTML = '';
            accountField.disabled = true;
            
            if (selectedType) {
                // تمكين حقل الاسم
                nameField.disabled = false;
                
                // إضافة الخيارات حسب النوع المختار
                switch (selectedType) {
                    case 'supplier':
                        addOptionsToSelect(nameField, getSuppliers());
                        break;
                    case 'employee':
                        addOptionsToSelect(nameField, getEmployees());
                        break;
                    case 'customer':
                        addOptionsToSelect(nameField, getCustomers());
                        break;
                    case 'cashbox':
                        addOptionsToSelect(nameField, getCashboxes());
                        break;
                    case 'bank':
                        addOptionsToSelect(nameField, getBanks());
                        break;
                }
            }
        });
        
        // معالجة تغيير اسم المستفيد/المصدر
        nameField.addEventListener('change', function() {
            const selectedName = this.value;
            const selectedType = typeField.value;
            
            // إعادة تعيين حقل الحساب المالي
            accountField.innerHTML = '';
            accountField.disabled = true;
            
            if (selectedName && selectedType) {
                // تمكين حقل الحساب المالي
                accountField.disabled = false;
                
                // إضافة الخيارات حسب النوع والاسم المختار
                switch (selectedType) {
                    case 'supplier':
                        addOptionsToSelect(accountField, getSupplierAccounts(selectedName));
                        break;
                    case 'employee':
                        addOptionsToSelect(accountField, getEmployeeAccounts(selectedName));
                        break;
                    case 'customer':
                        addOptionsToSelect(accountField, getCustomerAccounts(selectedName));
                        break;
                    case 'cashbox':
                        addOptionsToSelect(accountField, getCashboxAccounts(selectedName));
                        break;
                    case 'bank':
                        addOptionsToSelect(accountField, getBankAccounts(selectedName));
                        break;
                }
            }
        });
    }
    
    // وظيفة مساعدة لإضافة خيارات إلى قائمة منسدلة
    function addOptionsToSelect(selectElement, options) {
        // إضافة خيار افتراضي
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'اختر من القائمة';
        selectElement.appendChild(defaultOption);
        
        // إضافة الخيارات
        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.id;
            optionElement.textContent = option.name;
            selectElement.appendChild(optionElement);
        });
    }
    
    // وظائف وهمية لجلب البيانات (ستستبدل لاحقًا بطلبات AJAX للخادم)
    function getSuppliers() {
        return [
            { id: 1, name: 'الخطوط السعودية' },
            { id: 2, name: 'طيران الإمارات' },
            { id: 3, name: 'الخطوط القطرية' },
            { id: 4, name: 'شركة النقل الجماعي' }
        ];
    }
    
    function getEmployees() {
        return [
            { id: 1, name: 'أحمد محمد' },
            { id: 2, name: 'محمد علي' },
            { id: 3, name: 'فهد خالد' },
            { id: 4, name: 'عبدالله سعيد' }
        ];
    }
    
    function getCustomers() {
        return [
            { id: 1, name: 'سلطان العتيبي' },
            { id: 2, name: 'خالد المحمدي' },
            { id: 3, name: 'راشد الدوسري' },
            { id: 4, name: 'سعود القحطاني' }
        ];
    }
    
    function getCashboxes() {
        return [
            { id: 1, name: 'صندوق المكتب الرئيسي' },
            { id: 2, name: 'صندوق فرع الرياض' },
            { id: 3, name: 'صندوق فرع جدة' }
        ];
    }
    
    function getBanks() {
        return [
            { id: 1, name: 'بنك الراجحي' },
            { id: 2, name: 'البنك الأهلي السعودي' },
            { id: 3, name: 'بنك ساب' },
            { id: 4, name: 'بنك سامبا' }
        ];
    }
    
    // وظائف وهمية لجلب حسابات المالية
    function getSupplierAccounts(supplierName) {
        return [{ id: 1, name: 'حساب الموردين - ' + supplierName }];
    }
    
    function getEmployeeAccounts(employeeName) {
        return [{ id: 1, name: 'حساب الموظفين - ' + employeeName }];
    }
    
    function getCustomerAccounts(customerName) {
        return [{ id: 1, name: 'حساب العملاء - ' + customerName }];
    }
    
    function getCashboxAccounts(cashboxName) {
        return [{ id: 1, name: 'حساب الصناديق - ' + cashboxName }];
    }
    
    function getBankAccounts(bankName) {
        return [{ id: 1, name: 'حساب البنوك - ' + bankName }];
    }
</script>
{% endblock %}